<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Monitoring PZEM Realtime</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f0f2f5;
    }
    h2 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
    }
    th {
      background: #007BFF;
      color: white;
    }
    .normal {
      background-color: #d4edda;
    }
    .warning {
      background-color: #f8d7da;
    }
    button {
      margin-top: 20px;
      display: block;
      width: 100%;
      padding: 10px;
      background-color: #007BFF;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #loading {
      display: none;
      text-align: center;
      margin-top: 10px;
      font-size: 18px;
      color: #555;
    }
    #loading span {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin: 0 2px;
      background: #007BFF;
      border-radius: 50%;
      animation: loading 0.8s infinite alternate;
    }
    #loading span:nth-child(2) {
      animation-delay: 0.2s;
    }
    #loading span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes loading {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(-10px);
      }
    }
    @media (max-width: 600px) {
      table, th, td {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

  <h2>Realtime Monitoring PZEM</h2>

  <div id="loading">
    <span></span><span></span><span></span> 
    Loading data...
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Jam</th>
        <th>Tegangan (V)</th>
        <th>Arus (A)</th>
        <th>Daya (W)</th>
        <th>Frekuensi (Hz)</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <!-- Data terbaru akan muncul di sini -->
    </tbody>
  </table>

  <button onclick="downloadCSV()">Download Semua Data</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDeYF2Sp3-_1TIMIqpbnGSD9WruZcXwZ8E",
      authDomain: "gkm-sundec.firebaseapp.com",
      databaseURL: "https://gkm-sundec-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gkm-sundec",
      storageBucket: "gkm-sundec.appspot.com",
      messagingSenderId: "336581347048",
      appId: "1:336581347048:web:1fa0a2fc376aa30d2eab5d",
      measurementId: "G-3MZCY9NTD9"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const tableBody = document.getElementById("tableBody");
    const loading = document.getElementById("loading");

    function displayData() {
      loading.style.display = 'block'; // Tampilkan animasi loading

      database.ref('Log').once('value').then(snapshot => {
        const data = snapshot.val();
        if (data) {
          let latestDate = Object.keys(data).sort().pop();
          let times = Object.keys(data[latestDate]);
          let latestTime = times.sort().pop();
          const item = data[latestDate][latestTime];

          let voltage = parseFloat(item['1_Voltage'].replace(' V','')) || 0;
          let current = parseFloat(item['2_Current'].replace(' A','')) || 0;
          let power = parseFloat(item['3_Power'].replace(' W','')) || 0;
          let frequency = parseFloat(item['4_Frequency'].replace(' Hz','')) || 0;

          tableBody.innerHTML = `
            <tr class="${(voltage < 200 || voltage > 240) ? 'warning' : 'normal'}">
              <td>${latestDate}</td>
              <td>${latestTime}</td>
              <td>${voltage.toFixed(1)}</td>
              <td>${current.toFixed(2)}</td>
              <td>${power.toFixed(1)}</td>
              <td>${frequency.toFixed(1)}</td>
            </tr>
          `;
        }
      }).finally(() => {
        loading.style.display = 'none'; // Sembunyikan animasi loading setelah update
      });
    }

    // Ambil data awal
    displayData();

    // Update data setiap 5 detik
    setInterval(displayData, 5000);

    // Fungsi untuk download semua data
    function downloadCSV() {
      database.ref('Log').once('value').then(snapshot => {
        const data = snapshot.val();
        if (data) {
          let csv = 'Tanggal,Jam,Tegangan (V),Arus (A),Daya (W),Frekuensi (Hz)\n';
          Object.keys(data).forEach(tanggal => {
            Object.keys(data[tanggal]).forEach(jam => {
              const item = data[tanggal][jam];
              csv += `${tanggal},${jam},${(item['1_Voltage'] || '').replace(' V','')},${(item['2_Current'] || '').replace(' A','')},${(item['3_Power'] || '').replace(' W','')},${(item['4_Frequency'] || '').replace(' Hz','')}\n`;
            });
          });

          const blob = new Blob([csv], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'data_log_pzem.csv';
          a.click();
          window.URL.revokeObjectURL(url);
        }
      });
    }
  </script>

</body>
</html>
